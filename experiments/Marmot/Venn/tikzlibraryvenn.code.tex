% Copyright 2019 by an anonymous marmot
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/generic/pgf/licenses/LICENSE for more details.
% Big thanks go to JouleV and samcarter for feedback and suggestions!
\ProvidesFileRCS{tikzlibraryvenn.code.tex}
\usetikzlibrary{backgrounds,calc}
\newif\ifvenn@reversed
\newif\ifvenn@labelmath
\venn@reversedfalse
\tikzset{reuse path/.code={%
    \pgfsyssoftpath@setcurrentpath{#1}}
}% unfortunately this is *not* the definition of the `use path` key that has
% been added to the pgfmanual!
\tikzset{current reverse clip/.style={insert path={{% https://tex.stackexchange.com/a/127045
   (current bounding box.south east)  -|
  (current bounding box.north west) -| cycle
  }}},
  current reverse clip'/.style={insert path={{% https://tex.stackexchange.com/a/127045
   (current bounding box.south east)  -|
  (current bounding box.north west) -| cycle
  }}},
  even odd clip/.code={% https://tex.stackexchange.com/a/76216
  \pgfseteorule}}
\tikzset{Venn diagram/.style={/utils/exec=\tikzset{venn/.cd,#1},
 execute at begin scope={
 \pgfmathtruncatemacro{\pgfutil@tmpD}{dim(\pgfkeysvalueof{/tikz/venn/labels})}
 \ifnum\pgfutil@tmpD<\pgfkeysvalueof{/tikz/venn/number of sets}
 \tikzerror{Less labels then Venn sets.}%
 \fi
 \pgfmathsetmacro{\pgfutil@tmpA}{{\pgfkeysvalueof{/tikz/venn/labels}}[0]}
 \pgfmathsetmacro{\pgfutil@tmpB}{{\pgfkeysvalueof{/tikz/venn/labels}}[1]}
 \pgfmathsetmacro{\pgfutil@tmpC}{{\pgfkeysvalueof{/tikz/venn/labels}}[2]}
 \begin{scope}[local bounding box=Venn Box]
 \foreach \Set [count=\Num starting from 0] in {1,...,\pgfkeysvalueof{/tikz/venn/number of sets}}
 {\pgfmathsetmacro{\mylabel}{{\pgfkeysvalueof{/tikz/venn/labels}}[\Num]}
 \ifvenn@labelmath
  \draw[/tikz/venn/lines,/tikz/venn/circle \mylabel/.try] ({\pgfkeysvalueof{/tikz/venn/offset angle}+240-30*\pgfkeysvalueof{/tikz/venn/number of sets}+
  360*\Num/\pgfkeysvalueof{/tikz/venn/number of
  sets}}:\pgfkeysvalueof{/tikz/venn/distance})  
  coordinate[label={[anchor=center,/tikz/venn/all labels,/tikz/venn/label \mylabel/.try]:$\mylabel$}]
  (\pgfkeysvalueof{/tikz/venn/center prefix}\mylabel) circle[radius=\pgfkeysvalueof{/tikz/venn/radius}];
 \else 
  \draw[/tikz/venn/lines,/tikz/venn/circle \mylabel/.try] ({\pgfkeysvalueof{/tikz/venn/offset angle}+240-30*\pgfkeysvalueof{/tikz/venn/number of sets}+
  360*\Num/\pgfkeysvalueof{/tikz/venn/number of
  sets}}:\pgfkeysvalueof{/tikz/venn/distance}) 
  coordinate[label={[anchor=center,/tikz/venn/all labels,/tikz/venn/label \mylabel/.try]:\mylabel}]
  (\pgfkeysvalueof{/tikz/venn/center prefix}\mylabel) circle[radius=\pgfkeysvalueof{/tikz/venn/radius}];
 \fi}
 \end{scope}
 \pgf@venn@codes
 \draw[/tikz/venn/frame] ([xshift=-\pgfkeysvalueof{/tikz/venn/frame margin},
 yshift=-\pgfkeysvalueof{/tikz/venn/frame margin}]Venn Box.south west) 
 rectangle ([xshift=\pgfkeysvalueof{/tikz/venn/frame margin},
 yshift=\pgfkeysvalueof{/tikz/venn/frame margin}]Venn Box.north east); 
},on background layer},
venn/.cd,number of sets/.initial=3,distance/.initial=1cm,
center prefix/.initial=c,offset angle/.initial=0,
label math/.is if=venn@labelmath,label math=true,all labels/.style={},
radius/.initial=1.2cm,
labels/.initial={"A","B","C"},frame/.style={thick},
frame margin/.initial=3mm,lines/.style={thin},
style/.code=\tikzset{venn/pstyle/.style={#1}},pstyle/.style={fill=red},
and/.style args={#1 and #2}{insert path={
\ifvenn@reversed
 let \p1=($(\pgfkeysvalueof{/tikz/venn/center prefix}#2)-(\pgfkeysvalueof{/tikz/venn/center prefix}#1)$),
  \n1={veclen(\y1,\x1)/2},\n2={sqrt(\pgfkeysvalueof{/tikz/venn/radius}*\pgfkeysvalueof{/tikz/venn/radius}-\n1*\n1)},
  \n3={atan2(\y1,\x1)},\n4={atan2(\n2,\n1)} in 
 ($(\pgfkeysvalueof{/tikz/venn/center prefix}#1)+(\n3+\n4:\pgfkeysvalueof{/tikz/venn/radius})$)
 arc(\n3+\n4:\n3-\n4:\pgfkeysvalueof{/tikz/venn/radius}) 
 arc(\n3+180+\n4:\n3+180-\n4:\pgfkeysvalueof{/tikz/venn/radius}) 
 -- cycle
\else
 let \p1=($(\pgfkeysvalueof{/tikz/venn/center prefix}#2)-(\pgfkeysvalueof{/tikz/venn/center prefix}#1)$),
  \n1={veclen(\y1,\x1)/2},\n2={sqrt(\pgfkeysvalueof{/tikz/venn/radius}*\pgfkeysvalueof{/tikz/venn/radius}-\n1*\n1)},
  \n3={atan2(\y1,\x1)},\n4={atan2(\n2,\n1)} in 
 ($(\pgfkeysvalueof{/tikz/venn/center prefix}#1)+(\n3-\n4:\pgfkeysvalueof{/tikz/venn/radius})$)
 arc(\n3-\n4:\n3+\n4:\pgfkeysvalueof{/tikz/venn/radius}) 
 arc(\n3+180-\n4:\n3+180+\n4:\pgfkeysvalueof{/tikz/venn/radius}) 
 -- cycle
\fi}},
union/.style args={#1 and #2}{insert path={
 let \p1=($(\pgfkeysvalueof{/tikz/venn/center prefix}#2)-(\pgfkeysvalueof{/tikz/venn/center prefix}#1)$),
  \n1={veclen(\y1,\x1)/2},\n2={sqrt(\pgfkeysvalueof{/tikz/venn/radius}*\pgfkeysvalueof{/tikz/venn/radius}-\n1*\n1)},
  \n3={atan2(\y1,\x1)},\n4={atan2(\n2,\n1)} in 
 ($(\pgfkeysvalueof{/tikz/venn/center prefix}#1)+(\n3+\n4:\pgfkeysvalueof{/tikz/venn/radius})$)
 arc(\n3+\n4:\n3-\n4+360:\pgfkeysvalueof{/tikz/venn/radius}) 
 arc(\n3+180+\n4:\n3+180-\n4-360:\pgfkeysvalueof{/tikz/venn/radius}) 
 -- cycle
 }}, 
}  
\def\pgf@venn@codes{\def\Venn##1{\begin{scope}\tikzset{venn/.cd,##1}
\end{scope}}% 
\tikzset{venn/.cd,%
 set/.style={insert path={(\pgfkeysvalueof{/tikz/venn/center prefix}##1)
  circle[radius=\pgfkeysvalueof{/tikz/venn/radius}]}},
 % one set
 \pgfutil@tmpA/.code={%
  \path[venn/pstyle,##1] (\pgfkeysvalueof{/tikz/venn/center prefix}\pgfutil@tmpA) circle[radius=\pgfkeysvalueof{/tikz/venn/radius}]; },
 \pgfutil@tmpB/.code={%
  \path[venn/pstyle,##1] (\pgfkeysvalueof{/tikz/venn/center prefix}\pgfutil@tmpB) circle[radius=\pgfkeysvalueof{/tikz/venn/radius}]; },
 \pgfutil@tmpC/.code={%
  \path[venn/pstyle,##1] (\pgfkeysvalueof{/tikz/venn/center prefix}\pgfutil@tmpC) circle[radius=\pgfkeysvalueof{/tikz/venn/radius}]; },
 % intersections
 \pgfutil@tmpA n\pgfutil@tmpB/.code={%
  \path[venn/pstyle,##1,venn/and={{\pgfutil@tmpA} and \pgfutil@tmpB}]; },
 \pgfutil@tmpA n\pgfutil@tmpC/.code={%
  \path[venn/pstyle,##1,venn/and={{\pgfutil@tmpA} and \pgfutil@tmpC}]; },
 \pgfutil@tmpB n\pgfutil@tmpA/.code={%
  \path[venn/pstyle,##1,venn/and={{\pgfutil@tmpB} and \pgfutil@tmpA}]; },
 \pgfutil@tmpB n\pgfutil@tmpC/.code={%
  \path[venn/pstyle,##1,venn/and={{\pgfutil@tmpB} and \pgfutil@tmpC}]; },
 \pgfutil@tmpC n\pgfutil@tmpA/.code={%
  \path[venn/pstyle,##1,venn/and={{\pgfutil@tmpC} and \pgfutil@tmpA}]; },
 \pgfutil@tmpC n\pgfutil@tmpB/.code={%
  \path[venn/pstyle,##1,venn/and={{\pgfutil@tmpC} and \pgfutil@tmpB}]; },
 % unions 
 \pgfutil@tmpA u\pgfutil@tmpB/.code={%
  \path[venn/pstyle,##1,venn/union={{\pgfutil@tmpA} and \pgfutil@tmpB}]; },
 \pgfutil@tmpA u\pgfutil@tmpC/.code={%
  \path[venn/pstyle,##1,venn/union={{\pgfutil@tmpA} and \pgfutil@tmpC}]; },
 \pgfutil@tmpB u\pgfutil@tmpA/.code={%
  \path[venn/pstyle,##1,venn/union={{\pgfutil@tmpB} and \pgfutil@tmpA}]; },
 \pgfutil@tmpB u\pgfutil@tmpC/.code={%
  \path[venn/pstyle,##1,venn/union={{\pgfutil@tmpB} and \pgfutil@tmpC}]; },
 \pgfutil@tmpC u\pgfutil@tmpA/.code={%
  \path[venn/pstyle,##1,venn/union={{\pgfutil@tmpC} and \pgfutil@tmpA}]; },
 \pgfutil@tmpC u\pgfutil@tmpB/.code={%
  \path[venn/pstyle,##1,venn/union={{\pgfutil@tmpC} and \pgfutil@tmpB}]; },
 op/.code args={(##1)/(##2)}{\tikzset{venn/.cd,-##2,##1}},
 % exclusions 
 % one set
 -\pgfutil@tmpA/.code={%
  \path[clip] (\pgfkeysvalueof{/tikz/venn/center prefix}\pgfutil@tmpA) circle[radius=\pgfkeysvalueof{/tikz/venn/radius}] [current reverse clip']; },
 -\pgfutil@tmpB/.code={%
  \path[clip] (\pgfkeysvalueof{/tikz/venn/center prefix}\pgfutil@tmpB) circle[radius=\pgfkeysvalueof{/tikz/venn/radius}] [current reverse clip']; },
 -\pgfutil@tmpC/.code={%
  \path[clip] (\pgfkeysvalueof{/tikz/venn/center prefix}\pgfutil@tmpC) circle[radius=\pgfkeysvalueof{/tikz/venn/radius}] [current reverse clip'];
},
 % intersections
 -\pgfutil@tmpA n\pgfutil@tmpB/.code={%
  \path[clip,venn/and={{\pgfutil@tmpA} and \pgfutil@tmpB}] [current reverse clip]; },
 -\pgfutil@tmpA n\pgfutil@tmpC/.code={%
  \path[clip,venn/and={{\pgfutil@tmpA} and \pgfutil@tmpC}] [current reverse clip]; },
 -\pgfutil@tmpB n\pgfutil@tmpA/.code={%
  \path[clip,venn/and={{\pgfutil@tmpB} and \pgfutil@tmpA}] [current reverse clip]; },
 -\pgfutil@tmpB n\pgfutil@tmpC/.code={%
  \path[clip,venn/and={{\pgfutil@tmpB} and \pgfutil@tmpC}] [current reverse clip]; },
 -\pgfutil@tmpC n\pgfutil@tmpA/.code={%
  \path[clip,venn/and={{\pgfutil@tmpC} and \pgfutil@tmpA}] [current reverse clip]; },
 -\pgfutil@tmpC n\pgfutil@tmpB/.code={%
  \path[clip,venn/and={{\pgfutil@tmpC} and \pgfutil@tmpB}] [current reverse clip]; },
 % unions 
 -\pgfutil@tmpA u\pgfutil@tmpB/.code={%
  \path[clip,venn/union={{\pgfutil@tmpA} and \pgfutil@tmpB}] [current reverse clip]; },
 -\pgfutil@tmpA u\pgfutil@tmpC/.code={%
  \path[clip,venn/union={{\pgfutil@tmpA} and \pgfutil@tmpC}] [current reverse clip]; },
 -\pgfutil@tmpB u\pgfutil@tmpA/.code={%
  \path[clip,venn/union={{\pgfutil@tmpB} and \pgfutil@tmpA}] [current reverse clip]; },
 -\pgfutil@tmpB u\pgfutil@tmpC/.code={%
  \path[clip,venn/union={{\pgfutil@tmpB} and \pgfutil@tmpC}] [current reverse clip]; },
 -\pgfutil@tmpC u\pgfutil@tmpA/.code={%
  \path[clip,venn/union={{\pgfutil@tmpC} and \pgfutil@tmpA}] [current reverse clip]; },
 -\pgfutil@tmpC u\pgfutil@tmpB/.code={%
  \path[clip,venn/union={{\pgfutil@tmpC} and \pgfutil@tmpB}] [current reverse clip]; },  }  
}
\endinput

